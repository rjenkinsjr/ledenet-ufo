version: 2

jobs:
    build:
        environment:
            TZ: "/usr/share/zoneinfo/America/Detroit"
        working_directory: ~/app
        docker:
            - image: circleci/buildpack-deps:xenial-browsers
        steps:
            - add_ssh_keys
            - checkout
            - run:
                name: Install nvm/NodeJS/Yarn
                command: |
                  # Install nvm.
                  cd ~
                  git clone https://github.com/creationix/nvm.git .nvm
                  cd .nvm
                  git checkout `git describe --abbrev=0 --tags --match "v[0-9]*" origin`
                  . nvm.sh
                  # Install default/stable NodeJS.
                  nvm install stable
                  # Make nvm available in future shells.
                  echo 'export NVM_DIR="$HOME/.nvm"' >> $BASH_ENV
                  echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV
                  # Install Yarn.
                  curl -o- -L https://yarnpkg.com/install.sh | bash
                  # Make yarn available in future shells.
                  echo 'export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"' >> $BASH_ENV
            - run:
                name: Run tests
                command: |
                  yarn && testen --system -V
